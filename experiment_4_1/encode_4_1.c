#include "../stream.h"
#include "../vector.h"
#include "../wavio.h"
#include "../ans.h"
#include "assert.h"
#include "math.h"

static uint16_t codes_to_values[1024] = {
     0,     65,    129,    193,    257,    321,    385,    449,    513,    577,    641,    705,    769,    833,    897,    961,   1025,   1090,   1154,   1218,   1282,   1346,   1410,   1474,   1538,   1602,   1666,   1730,   1794,   1858,   1922,   1986,   2050,   2115,   2179,   2243,   2307,   2371,   2435,   2499,   2563,   2627,   2691,   2755,   2819,   2883,   2947,   3011,   3075,   3140,   3204,   3268,   3332,   3396,   3460,   3524,   3588,   3652,   3716,   3780,   3844,   3908,   3972,   4036, 
  4100,   4165,   4229,   4293,   4357,   4421,   4485,   4549,   4613,   4677,   4741,   4805,   4869,   4933,   4997,   5061,   5125,   5189,   5254,   5318,   5382,   5446,   5510,   5574,   5638,   5702,   5766,   5830,   5894,   5958,   6022,   6086,   6150,   6214,   6279,   6343,   6407,   6471,   6535,   6599,   6663,   6727,   6791,   6855,   6919,   6983,   7047,   7111,   7175,   7239,   7304,   7368,   7432,   7496,   7560,   7624,   7688,   7752,   7816,   7880,   7944,   8008,   8072,   8136, 
  8200,   8264,   8329,   8393,   8457,   8521,   8585,   8649,   8713,   8777,   8841,   8905,   8969,   9033,   9097,   9161,   9225,   9289,   9353,   9418,   9482,   9546,   9610,   9674,   9738,   9802,   9866,   9930,   9994,  10058,  10122,  10186,  10250,  10314,  10378,  10443,  10507,  10571,  10635,  10699,  10763,  10827,  10891,  10955,  11019,  11083,  11147,  11211,  11275,  11339,  11403,  11468,  11532,  11596,  11660,  11724,  11788,  11852,  11916,  11980,  12044,  12108,  12172,  12236, 
 12300,  12364,  12428,  12493,  12557,  12621,  12685,  12749,  12813,  12877,  12941,  13005,  13069,  13133,  13197,  13261,  13325,  13389,  13453,  13517,  13582,  13646,  13710,  13774,  13838,  13902,  13966,  14030,  14094,  14158,  14222,  14286,  14350,  14414,  14478,  14542,  14607,  14671,  14735,  14799,  14863,  14927,  14991,  15055,  15119,  15183,  15247,  15311,  15375,  15439,  15503,  15567,  15632,  15696,  15760,  15824,  15888,  15952,  16016,  16080,  16144,  16208,  16272,  16336, 
 16400,  16464,  16528,  16592,  16657,  16721,  16785,  16849,  16913,  16977,  17041,  17105,  17169,  17233,  17297,  17361,  17425,  17489,  17553,  17617,  17681,  17746,  17810,  17874,  17938,  18002,  18066,  18130,  18194,  18258,  18322,  18386,  18450,  18514,  18578,  18642,  18706,  18771,  18835,  18899,  18963,  19027,  19091,  19155,  19219,  19283,  19347,  19411,  19475,  19539,  19603,  19667,  19731,  19796,  19860,  19924,  19988,  20052,  20116,  20180,  20244,  20308,  20372,  20436, 
 20500,  20564,  20628,  20692,  20756,  20821,  20885,  20949,  21013,  21077,  21141,  21205,  21269,  21333,  21397,  21461,  21525,  21589,  21653,  21717,  21781,  21845,  21910,  21974,  22038,  22102,  22166,  22230,  22294,  22358,  22422,  22486,  22550,  22614,  22678,  22742,  22806,  22870,  22935,  22999,  23063,  23127,  23191,  23255,  23319,  23383,  23447,  23511,  23575,  23639,  23703,  23767,  23831,  23895,  23960,  24024,  24088,  24152,  24216,  24280,  24344,  24408,  24472,  24536, 
 24600,  24664,  24728,  24792,  24856,  24920,  24985,  25049,  25113,  25177,  25241,  25305,  25369,  25433,  25497,  25561,  25625,  25689,  25753,  25817,  25881,  25945,  26010,  26074,  26138,  26202,  26266,  26330,  26394,  26458,  26522,  26586,  26650,  26714,  26778,  26842,  26906,  26970,  27034,  27099,  27163,  27227,  27291,  27355,  27419,  27483,  27547,  27611,  27675,  27739,  27803,  27867,  27931,  27995,  28059,  28124,  28188,  28252,  28316,  28380,  28444,  28508,  28572,  28636, 
 28700,  28764,  28828,  28892,  28956,  29020,  29084,  29149,  29213,  29277,  29341,  29405,  29469,  29533,  29597,  29661,  29725,  29789,  29853,  29917,  29981,  30045,  30109,  30174,  30238,  30302,  30366,  30430,  30494,  30558,  30622,  30686,  30750,  30814,  30878,  30942,  31006,  31070,  31134,  31198,  31263,  31327,  31391,  31455,  31519,  31583,  31647,  31711,  31775,  31839,  31903,  31967,  32031,  32095,  32159,  32223,  32288,  32352,  32416,  32480,  32544,  32608,  32672,  32736, 
 32799,  32863,  32927,  32991,  33055,  33119,  33183,  33247,  33312,  33376,  33440,  33504,  33568,  33632,  33696,  33760,  33824,  33888,  33952,  34016,  34080,  34144,  34208,  34272,  34337,  34401,  34465,  34529,  34593,  34657,  34721,  34785,  34849,  34913,  34977,  35041,  35105,  35169,  35233,  35297,  35361,  35426,  35490,  35554,  35618,  35682,  35746,  35810,  35874,  35938,  36002,  36066,  36130,  36194,  36258,  36322,  36386,  36451,  36515,  36579,  36643,  36707,  36771,  36835, 
 36899,  36963,  37027,  37091,  37155,  37219,  37283,  37347,  37411,  37476,  37540,  37604,  37668,  37732,  37796,  37860,  37924,  37988,  38052,  38116,  38180,  38244,  38308,  38372,  38436,  38501,  38565,  38629,  38693,  38757,  38821,  38885,  38949,  39013,  39077,  39141,  39205,  39269,  39333,  39397,  39461,  39525,  39590,  39654,  39718,  39782,  39846,  39910,  39974,  40038,  40102,  40166,  40230,  40294,  40358,  40422,  40486,  40550,  40615,  40679,  40743,  40807,  40871,  40935, 
 40999,  41063,  41127,  41191,  41255,  41319,  41383,  41447,  41511,  41575,  41640,  41704,  41768,  41832,  41896,  41960,  42024,  42088,  42152,  42216,  42280,  42344,  42408,  42472,  42536,  42600,  42665,  42729,  42793,  42857,  42921,  42985,  43049,  43113,  43177,  43241,  43305,  43369,  43433,  43497,  43561,  43625,  43690,  43754,  43818,  43882,  43946,  44010,  44074,  44138,  44202,  44266,  44330,  44394,  44458,  44522,  44586,  44650,  44714,  44779,  44843,  44907,  44971,  45035, 
 45099,  45163,  45227,  45291,  45355,  45419,  45483,  45547,  45611,  45675,  45739,  45804,  45868,  45932,  45996,  46060,  46124,  46188,  46252,  46316,  46380,  46444,  46508,  46572,  46636,  46700,  46764,  46829,  46893,  46957,  47021,  47085,  47149,  47213,  47277,  47341,  47405,  47469,  47533,  47597,  47661,  47725,  47789,  47854,  47918,  47982,  48046,  48110,  48174,  48238,  48302,  48366,  48430,  48494,  48558,  48622,  48686,  48750,  48814,  48878,  48943,  49007,  49071,  49135, 
 49199,  49263,  49327,  49391,  49455,  49519,  49583,  49647,  49711,  49775,  49839,  49903,  49968,  50032,  50096,  50160,  50224,  50288,  50352,  50416,  50480,  50544,  50608,  50672,  50736,  50800,  50864,  50928,  50993,  51057,  51121,  51185,  51249,  51313,  51377,  51441,  51505,  51569,  51633,  51697,  51761,  51825,  51889,  51953,  52018,  52082,  52146,  52210,  52274,  52338,  52402,  52466,  52530,  52594,  52658,  52722,  52786,  52850,  52914,  52978,  53042,  53107,  53171,  53235, 
 53299,  53363,  53427,  53491,  53555,  53619,  53683,  53747,  53811,  53875,  53939,  54003,  54067,  54132,  54196,  54260,  54324,  54388,  54452,  54516,  54580,  54644,  54708,  54772,  54836,  54900,  54964,  55028,  55092,  55157,  55221,  55285,  55349,  55413,  55477,  55541,  55605,  55669,  55733,  55797,  55861,  55925,  55989,  56053,  56117,  56182,  56246,  56310,  56374,  56438,  56502,  56566,  56630,  56694,  56758,  56822,  56886,  56950,  57014,  57078,  57142,  57206,  57271,  57335, 
 57399,  57463,  57527,  57591,  57655,  57719,  57783,  57847,  57911,  57975,  58039,  58103,  58167,  58231,  58296,  58360,  58424,  58488,  58552,  58616,  58680,  58744,  58808,  58872,  58936,  59000,  59064,  59128,  59192,  59256,  59321,  59385,  59449,  59513,  59577,  59641,  59705,  59769,  59833,  59897,  59961,  60025,  60089,  60153,  60217,  60281,  60346,  60410,  60474,  60538,  60602,  60666,  60730,  60794,  60858,  60922,  60986,  61050,  61114,  61178,  61242,  61306,  61370,  61435, 
 61499,  61563,  61627,  61691,  61755,  61819,  61883,  61947,  62011,  62075,  62139,  62203,  62267,  62331,  62395,  62460,  62524,  62588,  62652,  62716,  62780,  62844,  62908,  62972,  63036,  63100,  63164,  63228,  63292,  63356,  63420,  63485,  63549,  63613,  63677,  63741,  63805,  63869,  63933,  63997,  64061,  64125,  64189,  64253,  64317,  64381,  64445,  64510,  64574,  64638,  64702,  64766,  64830,  64894,  64958,  65022,  65086,  65150,  65214,  65278,  65342,  65406,  65470,  65535
};

static uint16_t values_to_codes[65536];

void write_compressed_file(const char *filename, uint16_t *data, int num_samples) {
    const int alphabet_size = 1024;
    int quant_pow = R;
    for (int i = 0; i < alphabet_size; ++i) {
        values_to_codes[codes_to_values[i]] = i;
    }
    uint16_t *coded_data = (uint16_t *)malloc(sizeof(uint16_t) * num_samples);
    int32_t *occ = (int32_t *)malloc(sizeof(int32_t) * alphabet_size);
    memset(occ, 0, sizeof(int32_t) * alphabet_size);
    for (int i = 0; i < num_samples; ++i) {
        occ[values_to_codes[data[i]]]++;
        coded_data[i] = values_to_codes[data[i]];
    }
    vecStream sample_writing_stream = (vecStream){
        .ms = (memStream){
            .bit_buffer = 0,
            .bits_in_buffer = 0,
            .current_bytesize = 0,
            .total_bitsize = 0,
            .stream=(uint8_t *)malloc(sizeof(uint8_t) * 8192)
        },
        .stream_capacity = 8192
    };
    uint32_t final_state = encode16(coded_data, num_samples, &sample_writing_stream, occ, alphabet_size, quant_pow);
    finalize_vecstream(&sample_writing_stream);
    size_t total_bytesize = (sample_writing_stream.ms.total_bitsize % 8 == 0)
                            ? (sample_writing_stream.ms.total_bitsize / 8)
                            : (sample_writing_stream.ms.total_bitsize / 8 + 1);
    reverse_bits_memstream(&(sample_writing_stream.ms));
    FILE *file = fopen(filename, "wb");
    if (!file) {
        perror("Failed to open file");
        return;
    }
    // printf("num_samples=%d, final_state=%u\n", num_samples, final_state);
    fwrite(&quant_pow, sizeof(int), 1, file);
    fwrite(occ, sizeof(int32_t), alphabet_size, file);
    fwrite(&final_state, sizeof(uint32_t), 1, file);
    fwrite(&(num_samples), sizeof(int), 1, file);
    fwrite(&(sample_writing_stream.ms.total_bitsize), sizeof(size_t), 1, file);
    fwrite(sample_writing_stream.ms.stream, sizeof(uint8_t), total_bytesize, file);
    fclose(file);

    free(occ);
    free(sample_writing_stream.ms.stream);
    return;
}

int main(int argc, char **argv) {
    if (argc < 3) {
        printf("Usage: %s <input-wav-file> <compressed-file>\n", argv[0]);
        return 1;
    }
    WAVHeader header;
    size_t num_samples;

    uint16_t *data = read_wav_file(argv[1], &header, &num_samples);
    write_compressed_file(argv[2], data, num_samples);

    return 0;
}














